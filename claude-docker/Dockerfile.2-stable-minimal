# Layer 2: Settings and essential tools (minimal version)
FROM claude-docker:base

USER developer
WORKDIR /home/developer

# Add brew to PATH
ENV PATH="/home/linuxbrew/.linuxbrew/bin:${PATH}"

# Clone settings repo FIRST
RUN git clone https://github.com/idvorkin/settings.git ~/settings
RUN mkdir  ~/gits
RUN ln -s ~/settings ~/gits/settings

# Fix UV shebangs for Ubuntu 25.10 compatibility (requires -S flag)
RUN find ~/settings/py -name '*.py' -type f -exec sed -i 's|#!/usr/bin/env uv run --script|#!/usr/bin/env -S uv run --script|g' {} \;

# Install minimal essentials for bootstrap
RUN brew install zsh tmux neovim git

# Install oh-my-zsh (needed by bootstrap)
RUN sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" "" --unattended

# Create necessary directories for bootstrap
RUN mkdir -p ~/.config ~/.vim/bundle ~/.tmux/plugins ~/.ipython/profile_default

# Run bootstrap from settings repo to link all config files
RUN cd ~/settings && bash bootstrap.sh

# Install core development packages only
# Note: fzf excluded due to ARM build issues
RUN brew install \
    fd \
    ripgrep \
    just \
    python3 \
    node \
    bat \
    eza \
    zoxide \
    starship \
    jq \
    uv \
    yazi \
    duf \
    bottom \
    dua-cli \
    fastfetch \
    tig \
    procs \
    pre-commit \
    git-delta

# Install Claude CLI inside the container
RUN npm install -g @anthropic-ai/claude-code

# Install GitHub CLI (gh) using the current official method
USER root
RUN apt-get update && apt-get install -y curl
RUN curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg && \
    chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null && \
    apt update && \
    apt install -y gh

# Install Tailscale
RUN curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/oracular.noarmor.gpg | tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null && \
    curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/oracular.tailscale-keyring.list | tee /etc/apt/sources.list.d/tailscale.list && \
    apt-get update && \
    apt-get install -y tailscale && \
    mkdir -p /var/lib/tailscale /var/run/tailscale

USER developer

# Install yarn via npm
RUN npm install -g yarn


# Add cargo to PATH (if rust gets installed)
ENV PATH="/home/developer/.cargo/bin:${PATH}"

# Clone the main repos
RUN mkdir -p ~/gits && cd ~/gits && \
    git clone https://github.com/idvorkin/idvorkin.github.io.git && \
    git clone https://github.com/idvorkin/nlp.git

# Install Ruby and Jekyll dependencies
RUN brew install ruby && \
    echo 'export PATH="/home/linuxbrew/.linuxbrew/opt/ruby/bin:$PATH"' >> ~/.bashrc && \
    echo 'export PATH="/home/linuxbrew/.linuxbrew/opt/ruby/bin:$PATH"' >> ~/.zshrc

# Add Ruby and gem binaries to PATH for this build
ENV PATH="/home/linuxbrew/.linuxbrew/opt/ruby/bin:${PATH}"
ENV PATH="/home/linuxbrew/.linuxbrew/lib/ruby/gems/3.4.0/bin:${PATH}"

# Install Jekyll and bundler
RUN gem install jekyll bundler

# Install Jekyll dependencies for the blog
RUN cd ~/gits/idvorkin.github.io && \
    bundle config set --local path '~/.bundle' && \
    bundle install

# Install Node.js dependencies
RUN cd ~/gits/idvorkin.github.io && \
    npm install

# Install Playwright system dependencies (requires sudo)
USER root
RUN npm install -D @playwright/test@latest

# Install Playwright dependencies manually for Ubuntu 25.10 compatibility
# Playwright's auto-installer doesn't support 25.10 yet, so we install manually
# Note: Ubuntu 25.10 uses t64 (time_t 64-bit) package names
RUN apt-get update && apt-get install -y \
    libglib2.0-0t64 \
    libnss3 \
    libnspr4 \
    libdbus-1-3 \
    libatk1.0-0t64 \
    libatk-bridge2.0-0t64 \
    libcups2t64 \
    libdrm2 \
    libxcb1 \
    libxkbcommon0 \
    libx11-6 \
    libxcomposite1 \
    libxdamage1 \
    libxext6 \
    libxfixes3 \
    libxrandr2 \
    libgbm1 \
    libpango-1.0-0 \
    libcairo2 \
    libasound2t64 \
    libatspi2.0-0t64 \
    libwayland-client0 \
    && rm -rf /var/lib/apt/lists/*

USER developer
# Install Playwright browsers without system deps (we installed them manually above)
RUN npx playwright install chromium

# Setup GitHub auth helper
RUN echo '#!/bin/bash\n\
if [ -n "$GITHUB_TOKEN" ]; then\n\
    echo "$GITHUB_TOKEN" | gh auth login --with-token 2>/dev/null\n\
    gh auth status\n\
else\n\
    echo "No GITHUB_TOKEN set. Export GITHUB_TOKEN to enable gh commands."\n\
fi' > ~/setup-gh-auth.sh && chmod +x ~/setup-gh-auth.sh

# Add to shell startup
RUN echo '[ -f ~/setup-gh-auth.sh ] && ~/setup-gh-auth.sh' >> ~/.bashrc && \
    echo '[ -f ~/setup-gh-auth.sh ] && ~/setup-gh-auth.sh' >> ~/.zshrc

# Expose Jekyll ports
EXPOSE 4000 35729

# Run lazy sync headless to install all plugins during build (using bash since zsh path might not be standard)
RUN /bin/bash -c "nvim --headless '+Lazy! sync' +qa || true" && \
    echo "lazy.nvim plugins installed"

USER root
# Install terminal and utility packages
# Note: ncurses-term replaced by ncurses-base (already installed)
# kitty-terminfo not needed - kitty handles terminfo internally
RUN apt-get update && apt-get install -y \
    psmisc \
    && rm -rf /var/lib/apt/lists/*
USER developer

RUN brew install ruff prettier ag marksman typos-lsp
RUN brew install --build-from-source fzf
RUN brew install typescript-language-server lychee pyright

# Clone additional public repositories
RUN cd ~/gits && \
    git clone https://github.com/idvorkin/manager-book-redirect.git && \
    git clone https://github.com/idvorkin/chop-conventions.git && \
    git clone https://github.com/idvorkin/swing-analyzer.git && \
    git clone https://github.com/idvorkin/vapi-call-viewer.git && \
    git clone https://github.com/idvorkin/tony_tesla.git && \
    git clone https://github.com/idvorkin/jupyter.git && \
    git clone https://github.com/idvorkin/video-edit.git && \
    git clone https://github.com/idvorkin/time.ltd.git && \
    git clone https://github.com/idvorkin/cursor-party.git && \
    git clone https://github.com/idvorkin/humane-tracker-1.git

RUN cd ~/gits && \
    for repo in */; do \
        if [ -d "$repo/.git" ]; then \
            echo "Installing pre-commit hooks for $repo"; \
            (cd "$repo" && pre-commit install) || true; \
        fi; \
    done


WORKDIR /home/developer/
LABEL description="Settings configured with essential tools (minimal)"
