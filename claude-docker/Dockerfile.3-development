# Layer 3: Development layer for future enhancements
FROM claude-docker:minimal

# This layer is for future development and experimental features
# It builds on top of the stable minimal layer

# Copy container prompt configuration first as root
USER root
SHELL ["/bin/bash", "-c"]
COPY container-prompt.sh /etc/profile.d/container-prompt.sh
RUN chmod +x /etc/profile.d/container-prompt.sh

USER developer
WORKDIR /home/developer

# Use bash for commands (zsh is at different location)
SHELL ["/bin/bash", "-c"]




# Add any development tools or experimental features here
# Examples:
# - Additional language servers for neovim
# - Extra debugging tools
# - Development databases
# - Additional programming language runtimes

# Install modern terminal support

# Install Ghostty terminfo (if available) and other modern terminal definitions
USER root
RUN mkdir -p /usr/share/terminfo/x && \
    # Try to fetch Ghostty terminfo if available
    (curl -fsSL https://raw.githubusercontent.com/ghostty-org/ghostty/main/terminfo/ghostty.terminfo 2>/dev/null | tic -x - || true) && \
    # Also ensure we have good fallbacks
    echo "# Terminal compatibility" >> /etc/bash.bashrc && \
    echo "if [[ \"\$TERM\" == \"xterm-ghostty\" ]] && ! infocmp xterm-ghostty >/dev/null 2>&1; then" >> /etc/bash.bashrc && \
    echo "    export TERM=xterm-256color" >> /etc/bash.bashrc && \
    echo "fi" >> /etc/bash.bashrc

USER developer


# Add claude to PATH properly
ENV PATH="/home/linuxbrew/.linuxbrew/bin:${PATH}"

# Simple approach: just ensure directories exist for mounting
# Auth will be mounted directly from host

# Configure shell to use container prompt
RUN echo '# Docker container prompt setup' >> ~/.zshrc && \
    echo '[ -f /etc/profile.d/container-prompt.sh ] && source /etc/profile.d/container-prompt.sh' >> ~/.zshrc && \
    echo '# Docker container prompt setup' >> ~/.bashrc && \
    echo '[ -f /etc/profile.d/container-prompt.sh ] && source /etc/profile.d/container-prompt.sh' >> ~/.bashrc


WORKDIR /home/developer/
#
# Update the repos
# Clone the main repos
#

RUN echo v1

SHELL ["/home/linuxbrew/.linuxbrew/bin/zsh","-c"]

RUN cd ~/gits/settings && git pull
RUN ln -s ~/gits/idvorkin.github.io/ ~/blog
RUN mkdir ~/tmp
RUN zoxide add ~/settings ~/blog ~/tmp

RUN cd ~/gits && \
    for repo in */; do \
        if [ -d "$repo/.git" ]; then \
            echo "Updating $repo"; \
            cd $repo; \
            zoxide add .; \
            zoxide add .; \
            git clean -fd; \
            git fetch && git rebase --strategy-option=theirs && cd ..; \
        fi; \
    done

# Start Tailscale daemon on shell login (userspace networking mode)
# NOTE: This can be removed on next full rebuild - it's here for quick iteration
RUN echo '# Start Tailscale daemon if not already running' >> ~/.zshrc && \
    echo 'if ! pgrep -x tailscaled > /dev/null; then' >> ~/.zshrc && \
    echo '    sudo tailscaled --tun=userspace-networking --state=/var/lib/tailscale/tailscaled.state --socket=/var/run/tailscale/tailscaled.sock &>/dev/null &' >> ~/.zshrc && \
    echo '    sleep 1  # Wait for tailscaled to be ready' >> ~/.zshrc && \
    echo '    # Use container hostname (e.g., C-5000) for Tailscale machine name' >> ~/.zshrc && \
    echo '    sudo tailscale up --hostname="$(hostname)" &>/dev/null &' >> ~/.zshrc && \
    echo 'fi' >> ~/.zshrc

