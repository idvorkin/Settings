# Launch command
# Attach while detaching all other terminals
# Required as other terminals that are smaller will bind to smallest.
# Even more useful with mosh
#      tmux attach -d

# ============================================================================
# Custom Commands (via rust/tmux_helper - rmux_helper)
# ============================================================================
# Keybindings:
#   C-a t                - Update window title based on running process
#   C-a Shift+Space      - Rotate layout (toggle even-horizontal/even-vertical)
#   C-a /                - Toggle 1/3-2/3 layout (works with 2 panes)
#   C-a {                - Swap current pane with previous pane
#   C-a }                - Swap current pane with next pane
#
# Command Aliases (use via C-a : then type command):
#   :info                - Update window title based on running process
#   :rename-all          - Rename all tmux panes based on their current state
#   :rotate              - Rotate layout (toggle even-horizontal/even-vertical)
#   :third               - Toggle 1/3-2/3 layout (works with 2 panes)
#   :third "command"     - Split with 1/3-2/3 layout and run command in left pane
#   :tig / :Tig          - Open tig status in a new window
#   :gdiff / :Gdiff      - Open git diff in a new window
#   :ttig / :Ttig        - Split with 1/3-2/3 layout and run tig status in left pane
#   :tgdiff / :Tgdiff    - Split with 1/3-2/3 layout and run git diff in left pane
#   :launch-servers      - Start dev servers session (btm, caffeinate, jekyll, agent)
# ============================================================================

# cheat sheet:
# https://sanctum.geek.nz/arabesque/vi-mode-in-tmux/
# https://gist.github.com/andreyvit/2921703
# Help
# C-a n - next
# C-a p - prev
# C-a c - create
# C-a w - fzf session/window/pane picker (rmux_helper pick)
# C-a C-w - built-in session picker (fallback)
# list-keys -T copy-mode-vi

# C-A v - copy mode.
#    -> v begin selection
#    -> y yank selection
# C-A ] paste

# C-A arrow keys - switch panes
# C-A % - Split horizontal (make sidebar)
# C-A " - Split vertical
# C-A r - Source tmux config

# Run it via the mouse.
# set-option -g mouse on


# wsl doesn't honor chsh (??)
# Force it from my rc file
# Check for zsh in order: linuxbrew first, then /bin/zsh, else do nothing
if-shell "test -f /home/linuxbrew/.linuxbrew/bin/zsh" \
    'set -g default-shell /home/linuxbrew/.linuxbrew/bin/zsh; set -g default-command /home/linuxbrew/.linuxbrew/bin/zsh' \
    'if-shell "test -f /bin/zsh" \
        "set -g default-shell /bin/zsh; set -g default-command /bin/zsh" \
        ""'

# ============================================================================
# Session Persistence (for remote/mosh use)
# ============================================================================
# Keep tmux alive: auto-create new window only when last window of last session closes
# If other sessions exist, let this session die (detach-on-destroy will switch to another)
set-hook -g window-unlinked 'if-shell -F "#{&&:#{==:#{session_windows},0},#{==:#{server_sessions},1}}" "new-window"'
# Don't detach when session would be destroyed - switch to another or respawn
set-option -g detach-on-destroy off


# Start windows and panes at 1, not 0
# This makes life easier when touch typing
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on


# when in copy mode move ala vi.
# In iTerm - be sure to enable copy from app itself (Looks like that's what tmux is doing)
setw -g mode-keys vi

# C-B is the default prefix - but that's used via vi so use C-a instead.
unbind-key C-b
set -g prefix C-a
bind-key C-a send-prefix

# how about some nice vi like sane bindings

#enable true color
# Not quite sure what these lines do, but a close linkage is here;
# https://wiki.archlinux.org/index.php/tmux
#set-option -ga terminal-overrides ",xterm-256color:Tc,rxvt-unicode-256color:Tc"
# set -as terminal-overrides ',xterm*:Tc:sitm=\E[3m'
# All terminals I use should now be true color (or close enough) -- previous lines I've used are above.
set -as terminal-overrides ',xterm*:Tc'



# use v to enter copy mode
bind v copy-mode
bind V copy-mode
bind 3  select-layout even-horizontal


# Once in copy mode, use v to select and y to yank
bind-key -T copy-mode-vi 'v' send -X begin-selection
bind-key -T copy-mode-vi 'y' send -X copy-selection-and-cancel

# List of plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'catppuccin/tmux#v2.1.3'
set -g @plugin 'tmux-plugins/tmux-yank'
# Session/window/pane picker: C-a w for native skim picker, C-a C-w for built-in tree
bind-key w display-popup -E -w 100% -h 100% "rmux_helper pick-tui"
bind-key C-w choose-tree -Zw
# set -g @plugin 'Morantron/tmux-fingers'
# Cool idea, but doesn't work for me, I wonder if it's not compatible with power theme
set -g @tmux-nerd-font-window-name-shell-icon 'ï”'
set -g @tmux-nerd-font-window-name-show-name false
# I have a hunch this is messing stuff up
# set -g @plugin 'joshmedeski/tmux-nerd-font-window-name'

# C-A F (not the useful)
set -g @plugin 'sainnhe/tmux-fzf'

# Other examples:
# set -g @plugin 'github_username/plugin_nme'
# set -g @plugin 'git@github.com/user/plugin'
# set -g @plugin 'git@bitbucket.com/user/plugin'

# ============================================================================
# Catppuccin Theme Configuration
# ============================================================================
# Flavors: latte (light), frappe, macchiato, mocha (darkest)
# Default mocha, then override by host
set -g @catppuccin_flavor 'mocha'
set -g @catppuccin_window_status_style 'rounded'

# Use window name (#W) - set by tmux_helper
set -g @catppuccin_window_text " #W"
set -g @catppuccin_window_current_text " #W"

if '[ `hostname -s` = IgorBasementHP ]' \
       'set -g @catppuccin_flavor "frappe"'

# lightsail
if 'test -f /home/ec2-user/.vimrc' \
       'set -g @catppuccin_flavor "macchiato"'

# Mac
if 'test -f /Users/idvorkin/.tmux.conf' \
       'set -g @catppuccin_flavor "mocha"'

# Ms modifies OSC 52 clipboard handling to work with mosh, see
# https://gist.github.com/yudai/95b20e3da66df1b066531997f982b57b
# set -ag terminal-overrides "vte*:XT:Ms=\\E]52;c;%p2%s\\7,xterm*:XT:Ms=\\E]52;c;%p2%s\\7"

# enable OSC 52 clipboard
set -g set-clipboard on

unbind r
bind r source-file ~/.tmux.conf

# needed to get italics working in tmux
# https://github.com/tmux/tmux/wiki/FAQ#i-don't-see-italics-or-italics-and-reverse-are-the-wrong-way-round
# see - https://rsapkf.xyz/blog/enabling-italics-vim-tmux
# echo -e "\e[3m foo \e[23m"

set -g default-terminal "tmux"
# Sigh can't use screen because it doesn't support italics
# set -g default-terminal "screen-256color"
set-option -g allow-passthrough on



# Put status bar on top
# set-option -g status-position top
set-option -g status-position bottom

bind-key a run-shell 'open "/Applications/Alfred 5.app/"'
# bind-key a command-prompt "run-shell 'open \"/Applications/Alfred 5.app/\"'"

# Re-install plugin's w C-A I
# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
# $ git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm


# ============================================================================
# Catppuccin Status Line Configuration
# ============================================================================
# Load catppuccin BEFORE configuring status line
run '~/.tmux/plugins/tpm/tpm'

# Enable 2 status lines: row 1 = session/host/date, row 2 = windows (centered)
set -g status 2

# Clear default status-left/right (we use explicit status-format for both rows)
set -g status-left ""
set -g status-right ""

# ============================================================================
# Status Bar Row 1 Format (Linux)
# ============================================================================
# Layout: [LEFT] hostname session | [CENTER] pane-title | [RIGHT] cpu ram date
#
# Format codes:
#   #[align=left/centre/right] - alignment for following content
#   #[fg=#{@thm_X}]            - catppuccin theme color (yellow, green, peach, etc)
#   #{E:@catppuccin_status_X}  - catppuccin module (host, session, date_time)
#   #{E:@rename_trigger}       - runs rmux_helper rename-all silently
#   #T                         - pane title
#   #(cmd)                     - shell command output
#   %%                         - literal % (escaped)
#
# CPU: top -bn1 (batch mode, 1 iteration) -> grep idle% -> calc 100-idle
# RAM: free -m -> used/total * 100
# ============================================================================
set -g status-format[0] "#[align=left]#{E:@catppuccin_status_host}#{E:@catppuccin_status_session}#{E:@rename_trigger}#[align=centre,fg=#{@thm_peach},bold]#T#[align=right]#[fg=#{@thm_yellow}]CPU:#(top -bn1 | grep 'Cpu' | awk '{print 100-$8}' | cut -d. -f1)%% #[fg=#{@thm_green}]RAM:#(free -m | awk '/Mem:/ {printf \"%.0f\", $3/$2*100}')%% #[default]#{E:@catppuccin_status_date_time}"

# Custom date/time format (no seconds, no year)
set -g @catppuccin_date_time_text "%m-%d %H:%M"

# ============================================================================
# Status Bar Row 1 Format (macOS) - overrides Linux version above
# ============================================================================
# Layout: [LEFT] hostname session | [CENTER] pane-title | [RIGHT] cpu ram flow date
#
# Mac-specific differences:
#   hostname -s | sed "s/.../i"  - shorten "igors-Mac-mini" to "mac-mini" (case-insensitive)
#   top -l1                      - macOS top (1 sample, not batch mode like Linux)
#   memory_pressure              - macOS memory stats (no 'free' command)
#   y flow-info --oneline        - custom flow tracker (Igor's tool)
#
# To customize hostname: edit the sed pattern "s/OLD/NEW/i"
# Available catppuccin colors: @thm_red, @thm_peach, @thm_yellow, @thm_green,
#   @thm_teal, @thm_blue, @thm_mauve, @thm_flamingo, @thm_pink, @thm_lavender
# ============================================================================
if 'test "$(uname)" = "Darwin"' \
    'set -g status-format[0] "#[align=left]#[fg=#{@thm_mauve}]#(hostname -s | sed \"s/igors-Mac-mini/mac-mini/i\") #{E:@catppuccin_status_session}#{E:@rename_trigger}#[align=centre,fg=#{@thm_peach},bold]#T#[align=right]#[fg=#{@thm_yellow}]CPU:#(top -l1 | grep \"CPU usage\" | awk \"{print \\$3}\" | cut -d. -f1)%% #[fg=#{@thm_green}]RAM:#(memory_pressure | grep \"System-wide\" | awk \"{print 100-\\$5}\")%% #[fg=#{@thm_teal}]#(pmset -g batt | grep -Eo \"[0-9]+%%\" | head -1) #[fg=#{@thm_flamingo}]#(y flow-info --oneline) #[default]#{E:@catppuccin_status_date_time}"'

# ============================================================================
# Status Bar Row 2: Centered Window List
# ============================================================================
# Uses catppuccin window styling via #{W:format,current-format}
# The W format iterates windows: first arg for inactive, second for active
# ============================================================================
set -g status-format[1] "#[align=centre]#{W:#{E:window-status-format},#{E:window-status-current-format}}"

# remove the left hand part of the status bar
# set -g status-left-length 1

# See status options via
# tmux show-options -g | grep themepack





# Move windows around
bind-key -n C-S-Left swap-window -t -1\; select-window -t -1
bind-key -n C-S-Right swap-window -t +1\; select-window -t +1

bind-key t run-shell "rmux_helper info"

# ============================================================================
# Custom Layout Rotation
# ============================================================================
# Toggles between even-horizontal and even-vertical layouts using tmux_helper
# Prefix + Shift+Space: Toggle layout between even-horizontal/even-vertical
# ============================================================================
bind-key S-Space run-shell "rmux_helper rotate"

# Reset C-a o to default (cycle through panes)
bind-key o select-pane -t :.+

# ============================================================================
# Custom Layout: 1/3 - 2/3 Split
# ============================================================================
# Toggles between even layout and 1/3-2/3 layout (works with 2 panes)
# Prefix + /: Toggle between even and 1/3-2/3 layout
# Prefix + : then type 'third': Toggle layout via command prompt
# Prefix + : then type 'third "command"': Split with 1/3-2/3 and run command
#
# Examples:
#   :third "lazygit"     - Split and run lazygit in left pane
#   :third "htop"        - Split and run htop in left pane
# ============================================================================
bind-key / run-shell "rmux_helper third"

# ============================================================================
# tmux_helper Command Aliases
# ============================================================================
# Use these commands via Prefix + : then type the command name
#
# IMPORTANT: Keep these commands in sync with nvim commands in nvim/nvim_init.lua
# The nvim :Tig and :GitDiff commands use the same patterns for consistency
# ============================================================================
set -s command-alias[100] info='run-shell "rmux_helper info"'
set -s command-alias[101] rename-all='run-shell "rmux_helper rename-all"'
set -s command-alias[102] rotate='run-shell "rmux_helper rotate"'
set -s command-alias[103] third='run-shell "rmux_helper third"'
# tig: Opens tig status in new window
# - Uses "; exit" to close cleanly when tig exits
# - See also: nvim/nvim_init.lua :Tig command
set -s command-alias[104] tig='new-window -n "tig-status" -c "#{pane_current_path}" "tig status; exit"'
set -s command-alias[105] Tig='new-window -n "tig-status" -c "#{pane_current_path}" "tig status; exit"'
# gdiff: Opens git diff with delta formatting in new window
# - Pipes through delta for syntax highlighting
# - Uses "; read" to wait for keypress before closing
# - See also: nvim/nvim_init.lua :GitDiff command
set -s command-alias[106] gdiff='new-window -n "git-diff" -c "#{pane_current_path}" "git diff | delta; read"'
set -s command-alias[107] Gdiff='new-window -n "git-diff" -c "#{pane_current_path}" "git diff | delta; read"'
# ttig: Split current window with 1/3-2/3 layout and run tig status in left pane
set -s command-alias[108] ttig='run-shell "rmux_helper third \"tig status\""'
set -s command-alias[109] Ttig='run-shell "rmux_helper third \"tig status\""'
# tgdiff: Split current window with 1/3-2/3 layout and run git diff in left pane
set -s command-alias[110] tgdiff='run-shell "rmux_helper third \"git diff | delta\""'
set -s command-alias[111] Tgdiff='run-shell "rmux_helper third \"git diff | delta\""'
# launch-servers: Start dev servers session (btm, caffeinate, jekyll, agent-dashboard)
set -s command-alias[112] launch-servers='run-shell "rmux_helper launch-servers"'
#
# To add more commands like this:
#   set -s command-alias[113] foo='run-shell "rmux_helper third \"your command\""'

# ============================================================================
# Auto-rename windows every 10 seconds
# ============================================================================
# Use status-interval to trigger rename-all via a dummy status element
set -g status-interval 10
# Run rename-all silently on each status refresh (fast with Rust - 14ms)
set -g @rename_trigger '#(rmux_helper rename-all >/dev/null 2>&1 && echo "")'

